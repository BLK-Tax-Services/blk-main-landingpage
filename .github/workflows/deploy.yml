name: Deploy Landing Page to VPS

#env:
#  HUSKY: 0

on:
  push:
    branches:
      - production  # Trigger on push to main (adjust as needed)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Checkout the code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up Node.js (match your project's Node version)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'  # Adjust to your Node version
          cache: 'npm'

      # Install dependencies and build
      - name: Install Dependencies
        run: npm ci  # Cleaner install for CI/CD
      - name: Build TypeScript
        run: npm run build

      # Deploy to VPS via SSH
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          #          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            echo "âœ… Connected via SSH to $(whoami)@$(hostname)"

            # Write the Git SSH key to a file
            echo "${{ secrets.GIT_SSH_KEY }}" > ~/.ssh/github_deploy_key
            chmod 600 ~/.ssh/github_deploy_key
            # Set PATH for npm and pm2 (adjust as needed)
            export PATH=$PATH:/usr/local/bin:/home/blk/.nvm/versions/node/*/bin
            cd /home/blk

            GIT_SSH_COMMAND="ssh -i ~/.ssh/github_deploy_key" git clone git@github.com:BLK-Tax-Services/blk-main-landingpage.git landing

            git checkout production
            
            cd /home/blk/landing

            GIT_SSH_COMMAND="ssh -i ~/.ssh/github_deploy_key" git pull origin production
            
            # Fix PATH issue for non-interactive SSH sessions
            export PATH=$HOME/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$HOME/.npm-global/bin:$HOME/.nvm/versions/node/v22.12.0/bin

            # Verify node and npm exist in PATH
            echo "ğŸ” Checking Node.js and npm..."
            which node || { echo "âŒ Node.js not found in PATH. Exiting."; exit 1; }
            which npm || { echo "âŒ npm not found in PATH. Exiting."; exit 1; }
            node -v || { echo "âŒ Node.js not installed. Exiting."; exit 1; }
            npm -v || { echo "âŒ npm not installed. Exiting."; exit 1; }

            # Ensure PM2 is installed
            if ! command -v pm2 &> /dev/null; then
              echo "âš  PM2 not found! Installing..."
              npm install -g pm2
            fi

            cd /home/blk/landing || { echo "âŒ Directory not found! Exiting."; exit 1; }

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci || { echo "âŒ npm ci failed! Exiting."; exit 1; }
            npm run build || { echo "âŒ npm run build failed! Exiting."; exit 1; }

            # Stop and restart all PM2 processes
            echo "ğŸš€ Restarting all PM2 processes..."
            pm2 restart all

            echo "âœ… Successfully Deployed Landing page app"

